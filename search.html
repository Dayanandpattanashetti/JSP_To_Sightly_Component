<sly data-sly-use.search="com.example.SearchModel"
     data-sly-use.i18n="com.adobe.granite.i18n.I18n"
     data-sly-use.clientlib="/libs/granite/sightly/templates/clientlib.html"
     data-sly-test.hasQuery="${properties.q}"
     data-sly-use.uriHelper="com.adobe.cq.wcm.core.components.models.helpers.URITranslator">

    <sly data-sly-call="${clientlib.all}" data-sly-unwrap
         categories="[cq.wcm.foundation.search.v1]"/>

    <center>
        <form action="${currentPage.path}.html">
            <input size="41" maxlength="2048" name="q" value="${search.query @ context='attribute'}"/>
            <input value="${i18n.get('searchButtonText', resourceBundle) @ context='attribute'}" type="submit"/>
        </form>
    </center>
    <br/>

    <sly data-sly-test="${!search.hasResults && !hasQuery}">
        <!-- No initial content, do nothing -->
    </sly>

    <sly data-sly-test="${!search.hasResults && hasQuery}">
        <sly data-sly-test="${search.spellcheck}">
            <p>${i18n.get('spellcheckText', resourceBundle)} <a href="${currentPage.path}.html?q=${search.spellcheck @ context='uri'}"><b>${search.spellcheck @ context='html'}</b></a></p>
        </sly>
        <p>${i18n.get('noResultsText', resourceBundle, search.query @ context='html')}</p>
    </sly>

    <sly data-sly-test="${search.hasResults}">
        <p class="searchmeta">Results ${search.startIndex + 1} - ${search.endIndex} of ${search.totalMatches} for
            <b>${search.query @ context='html'}</b>. (${search.executionTime} seconds)
        </p>
        <br/>

        <div class="searchresults">
            <div class="results">
                <sly data-sly-list.hit="${search.hits}">
                    <div class="hit">
                        <a href="${hit.URL @ context='uri'}">${hit.title @ context='html'}</a>
                        <div class="excerpt">${hit.excerpt @ context='html'}</div>
                        <div class="hiturl"> ${hit.URL @ context='uri'}
                            <sly data-sly-test="${hit.lastModified}">
                                - ${hit.lastModified @ format='medium'}
                            </sly>
                             - <a href="${hit.similarURL @ context='uri'}">${i18n.get('similarPagesText', resourceBundle) @ context='html'}</a>
                        </div>
                    </div>
                </sly>
            </div>
            <br/>

            <div class="searchRight">
                <sly data-sly-test="${search.trends.queries.length > 0}">
                    <p>${i18n.get('searchTrendsText', resourceBundle)}</p>
                    <div class="searchTrends">
                        <sly data-sly-list.query="${search.trends.queries}">
                            <a href="${currentPage.path}.html?q=${query.query @ context='uri'}"><span
                                    style="font-size:${query.size}px">${query.query @ context='html'}</span></a>
                        </sly>
                    </div>
                </sly>

                <sly data-sly-test="${search.facets.languages.containsHit}">
                  <p>Languages</p>
                  <sly data-sly-list.bucket="${search.facets.languages.buckets}">
                    <sly data-sly-test.language="${java.util.Locale.new(bucket.value)}">
                      <sly data-sly-test.label="${language.getDisplayLanguage(resource.locale)}"></sly>
                      <sly data-sly-test.languageParam="${request.getParameter('language')}"></sly>
                      <sly data-sly-test.isCurrentLanguage="${languageParam == bucket.value}">
                        ${label} (${bucket.count}) - <a href="${currentPage.path}.html?${uriHelper.removeParameter(request, 'language', bucket.value) @ context='uri'}">remove filter</a>
                      </sly>
                      <sly data-sly-test="${!isCurrentLanguage}">
                        <a title="filter results" href="${currentPage.path}.html?${uriHelper.addParameter(request, 'language', bucket.value) @ context='uri'}">${label} (${bucket.count})</a>
                      </sly>
                      <br/>
                    </sly>
                  </sly>
                </sly>

                <sly data-sly-test="${search.facets.tags.containsHit}">
                    <p>Tags</p>
                    <sly data-sly-list.bucket="${search.facets.tags.buckets}">
                        <sly data-sly-test.tag="${search.tagManager.resolve(bucket.value)}">
                            <sly data-sly-test.label="${tag.title @ context='html'}"></sly>
                            <sly data-sly-test.tagParams="${request.getParameterValues('tag')}"></sly>
                            <sly data-sly-test.isCurrentTag="${tagParams && tagParams.contains(bucket.value)}">
                                ${label} (${bucket.count}) - <a href="${currentPage.path}.html?${uriHelper.removeParameter(request, 'tag', bucket.value) @ context='uri'}">remove filter</a>
                            </sly>
                            <sly data-sly-test="${!isCurrentTag}">
                                <a title="filter results" href="${currentPage.path}.html?${uriHelper.addParameter(request, 'tag', bucket.value) @ context='uri'}">${label} (${bucket.count})</a>
                            </sly>
                            <br/>
                        </sly>
                    </sly>
                </sly>

                <sly data-sly-test="${search.facets.mimeTypes.containsHit}">
                    <p>File types</p>
                    <sly data-sly-list.bucket="${search.facets.mimeTypes.buckets}">
                        <sly data-sly-test.label="${search.fileTypes[bucket.value] @ context='html'}"></sly>
                        <sly data-sly-test.mimeTypeParams="${request.getParameterValues('mimeType')}"></sly>
                        <sly data-sly-test.isCurrentMimeType="${mimeTypeParams && mimeTypeParams.contains(bucket.value)}">
                            ${label} (${bucket.count}) - <a href="${currentPage.path}.html?${uriHelper.removeParameter(request, 'mimeType', bucket.value) @ context='uri'}">remove filter</a>
                        </sly>
                        <sly data-sly-test="${!isCurrentMimeType}">
                            <a title="filter results" href="${currentPage.path}.html?${uriHelper.addParameter(request, 'mimeType', bucket.value) @ context='uri'}">${label} (${bucket.count})</a>
                        </sly>
                        <br/>
                    </sly>
                </sly>

                <sly data-sly-test="${search.relatedQueries.length > 0}">
                    <br/><br/>
                    <div class="related">
                        <p>${i18n.get('relatedSearchesText', resourceBundle)}</p>
                        <sly data-sly-list.rq="${search.relatedQueries}">
                            <a href="${currentPage.path}.html?q=${rq @ context='uri'}">${rq @ context='html'}</a>
                        </sly>
                    </div>
                </sly>
            </div>

            <sly data-sly-test="${search.resultPages.length > 1}">
                <div class="pagination">
                    <p>${i18n.get('resultPagesText', resourceBundle)}</p>
                    <sly data-sly-test="${search.previousPage}">
                        <a href="${search.previousPage.URL @ context='uri'}">${i18n.get('previousText', resourceBundle) @ context='html'}</a>
                    </sly>
                    <sly data-sly-list.page="${search.resultPages}">
                        <sly data-sly-test="${page.currentPage}">${page.index + 1}</sly>
                        <sly data-sly-test="${!page.currentPage}">
                            <a href="${page.URL @ context='uri'}">${page.index + 1}</a>
                        </sly>
                    </sly>
                    <sly data-sly-test="${search.nextPage}">
                        <a href="${search.nextPage.URL @ context='uri'}">${i18n.get('nextText', resourceBundle) @ context='html'}</a>
                    </sly>
                </div>
            </sly>
        </div>
    </sly>
</sly>